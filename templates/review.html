<!DOCTYPE html>
<html>
<head>
    <title>Recording Review</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .stats { display: flex; gap: 20px; margin: 15px 0; }
        .stat { flex: 1; background: #e3f2fd; padding: 15px; border-radius: 4px; text-align: center; }
        .viewer { background: white; padding: 20px; border-radius: 8px; }
        .screenshot-container { text-align: center; margin: 20px 0; position: relative; }
        .screenshot { max-width: 100%; max-height: 600px; border: 2px solid #ddd; border-radius: 4px; }
        .controls { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .btn { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-secondary { background: #008CBA; color: white; }
        .btn-secondary:hover { background: #007399; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .info { background: #f9f9f9; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .info-label { font-weight: bold; color: #666; }
        .action-text { font-family: monospace; background: #f4f4f4; padding: 8px; border-radius: 4px; }
        .counter { font-size: 18px; font-weight: bold; margin: 10px 0; }
        .deleted-notice { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Recording Review</h1>
            <div class="stats">
                <div class="stat">
                    <div style="font-size: 24px; font-weight: bold;" id="total-count">{{ total_screenshots }}</div>
                    <div>Total Screenshots</div>
                </div>
                <div class="stat">
                    <div style="font-size: 24px; font-weight: bold;" id="total-size">{{ total_size_mb }} MB</div>
                    <div>Total Size</div>
                </div>
                <div class="stat">
                    <div style="font-size: 24px; font-weight: bold;" id="current-index">0</div>
                    <div>Current Index</div>
                </div>
            </div>
            <p><em>Review your screenshots and delete any sensitive data before submitting to GCS</em></p>
        </div>

        <div class="viewer">
            <div class="counter" id="counter"></div>
            
            <div class="screenshot-container">
                <img id="screenshot" class="screenshot" src="" alt="Screenshot">
            </div>

            <div class="info">
                <div class="info-label">Action:</div>
                <div class="action-text" id="action-text">Loading...</div>
            </div>

            <div class="info">
                <div class="info-label">Filename:</div>
                <div id="filename">-</div>
            </div>

            <div class="info">
                <div class="info-label">Size:</div>
                <div id="filesize">-</div>
            </div>

            <div id="deleted-notice" class="deleted-notice" style="display: none;">
                [OK] Screenshot deleted
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="prev-btn" onclick="navigate(-1)"><- Previous</button>
                <button class="btn btn-danger" id="delete-btn" onclick="deleteScreenshot()">Delete</button>
                <button class="btn btn-secondary" id="next-btn" onclick="navigate(1)">Next -></button>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="finishReview()">[OK] Finish Review</button>
            </div>
        </div>
    </div>

    <script>
        let screenshots = [];
        let currentIndex = 0;

        async function loadScreenshots() {
            const response = await fetch('/api/screenshots');
            screenshots = await response.json();
            if (screenshots.length > 0) {
                showScreenshot(0);
            } else {
                document.getElementById('counter').textContent = 'No screenshots found';
            }
        }

        function showScreenshot(index) {
            if (screenshots.length === 0) return;
            
            currentIndex = Math.max(0, Math.min(index, screenshots.length - 1));
            const screenshot = screenshots[currentIndex];
            
            document.getElementById('screenshot').src = `/api/screenshot/${screenshot.name}`;
            document.getElementById('counter').textContent = `Screenshot ${currentIndex + 1} of ${screenshots.length}`;
            document.getElementById('current-index').textContent = currentIndex + 1;
            document.getElementById('action-text').textContent = screenshot.action;
            document.getElementById('filename').textContent = screenshot.name;
            document.getElementById('filesize').textContent = `${screenshot.size_kb.toFixed(1)} KB`;
            
            // Update button states
            document.getElementById('prev-btn').disabled = currentIndex === 0;
            document.getElementById('next-btn').disabled = currentIndex === screenshots.length - 1;
            
            // Hide deleted notice
            document.getElementById('deleted-notice').style.display = 'none';
        }

        function navigate(direction) {
            showScreenshot(currentIndex + direction);
        }

        async function deleteScreenshot() {
            if (screenshots.length === 0) return;
            
            const screenshot = screenshots[currentIndex];
            
            if (!confirm(`Delete ${screenshot.name}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete/${screenshot.name}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Show deleted notice
                    document.getElementById('deleted-notice').style.display = 'block';
                    
                    // Remove from list
                    screenshots.splice(currentIndex, 1);
                    
                    // Update stats
                    await updateStats();
                    
                    // Show next screenshot or previous if at end
                    if (screenshots.length === 0) {
                        document.getElementById('counter').textContent = 'No screenshots remaining';
                        document.getElementById('screenshot').src = '';
                        document.getElementById('action-text').textContent = 'All screenshots deleted';
                    } else if (currentIndex >= screenshots.length) {
                        showScreenshot(screenshots.length - 1);
                    } else {
                        showScreenshot(currentIndex);
                    }
                } else {
                    alert('Failed to delete screenshot');
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        async function updateStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            document.getElementById('total-count').textContent = stats.count;
            document.getElementById('total-size').textContent = `${stats.size_mb.toFixed(1)} MB`;
        }

        function finishReview() {
            const remaining = screenshots.length;
            const message = `Review complete!\n\nRemaining screenshots: ${remaining}\n\nNext step: Run 'python submit.py -s init --snake_name YOUR_NAME' to submit your snake and recordings`;
            alert(message);
            window.close();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteScreenshot();
            }
        });

        // Load on start
        loadScreenshots();
    </script>
</body>
</html>
